<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Gestión de Agenda</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* Paleta General */
            --bg: #f0f2f5;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            
            /* Colores Semánticos de Eventos */
            --color-audiencia: #3b82f6; /* Azul */
            --color-gesell: #f59e0b;    /* Naranja */
            --color-venc: #ef4444;      /* Rojo */
            --color-recurso: #8b5cf6;   /* Violeta */
            --color-diligencia: #10b981;/* Verde */
            
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Header --- */
        header {
            background: var(--surface);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        .header-title p {
            margin: 4px 0 0;
            color: var(--text-sec);
            font-size: 0.9rem;
        }

        /* --- Filters --- */
        .filters {
            display: flex;
            gap: 12px;
        }

        select {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background-color: #f9fafb;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }
        select:hover { border-color: #d1d5db; }
        select:focus { border-color: var(--color-audiencia); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        /* --- Main Layout --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* --- KPI Grid --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-top: 5px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-4px); }

        .kpi-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .kpi-icon {
            width: 36px; height: 36px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .kpi-title { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--text-sec); letter-spacing: 0.5px; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .kpi-sub { font-size: 0.8rem; margin-top: 8px; color: var(--text-sec); }
        .kpi-sub strong { color: var(--text-main); }

        /* Colores Específicos KPI */
        .kpi-audiencia { border-color: var(--color-audiencia); }
        .kpi-audiencia .kpi-icon { background: #eff6ff; color: var(--color-audiencia); }
        
        .kpi-gesell { border-color: var(--color-gesell); }
        .kpi-gesell .kpi-icon { background: #fffbeb; color: var(--color-gesell); }
        
        .kpi-venc { border-color: var(--color-venc); }
        .kpi-venc .kpi-icon { background: #fef2f2; color: var(--color-venc); }

        .kpi-recurso { border-color: var(--color-recurso); }
        .kpi-recurso .kpi-icon { background: #f5f3ff; color: var(--color-recurso); }

        .kpi-diligencia { border-color: var(--color-diligencia); }
        .kpi-diligencia .kpi-icon { background: #ecfdf5; color: var(--color-diligencia); }

        /* --- Dashboard Rows --- */
        .dashboard-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 1000px) { .dashboard-row { grid-template-columns: 1fr; } }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .card-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

        /* Barras de Progreso / Listas */
        .stat-item { margin-bottom: 12px; }
        .stat-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; }
        .stat-label { font-weight: 500; }
        .stat-num { font-weight: 700; }
        
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        /* Loading */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 50;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e5e7eb;
            border-top: 4px solid var(--color-audiencia); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-weight: 600; color: var(--text-sec);">Analizando Eventos...</div>
    </div>

    <header>
        <div class="filters">
            <select id="yearFilter">
                <option value="all">Histórico Completo</option>
                </select>
            <select id="userFilter">
                <option value="all">-- Todos los Empleados --</option>
                </select>
        </div>
    </header>

    <main class="container">
        
        <section class="kpi-grid">
            
            <div class="kpi-card kpi-audiencia">
                <div>
                    <div class="kpi-header">
                        <div class="kpi-icon"><i class="fas fa-users"></i></div>
                        <span class="kpi-title">Audiencias</span>
                    </div>
                    <div class="kpi-value" id="valAudiencia">0</div>
                </div>
                <div class="kpi-sub">
                    <span id="subAudiencia">0</span> Pendientes
                </div>
            </div>

            <div class="kpi-card kpi-gesell">
                <div>
                    <div class="kpi-header">
                        <div class="kpi-icon"><i class="fas fa-child"></i></div>
                        <span class="kpi-title">Cámara Gesell</span>
                    </div>
                    <div class="kpi-value" id="valGesell">0</div>
                </div>
                <div class="kpi-sub">
                    <span id="subGesell">0</span> Pendientes
                </div>
            </div>

            <div class="kpi-card kpi-venc">
                <div>
                    <div class="kpi-header">
                        <div class="kpi-icon"><i class="fas fa-exclamation-circle"></i></div>
                        <span class="kpi-title">Vencimientos</span>
                    </div>
                    <div class="kpi-value" id="valVenc">0</div>
                </div>
                <div class="kpi-sub">
                    Del proceso principal
                </div>
            </div>

            <div class="kpi-card kpi-recurso">
                <div>
                    <div class="kpi-header">
                        <div class="kpi-icon"><i class="fas fa-gavel"></i></div>
                        <span class="kpi-title">Recursos</span>
                    </div>
                    <div class="kpi-value" id="valRecurso">0</div>
                </div>
                <div class="kpi-sub">
                    Vencimientos de Queja/Recurso
                </div>
            </div>

            <div class="kpi-card kpi-diligencia">
                <div>
                    <div class="kpi-header">
                        <div class="kpi-icon"><i class="fas fa-shipping-fast"></i></div>
                        <span class="kpi-title">Diligencias</span>
                    </div>
                    <div class="kpi-value" id="valDiligencia">0</div>
                </div>
                <div class="kpi-sub">
                    Cantidad de Diligencias Varias
                </div>
            </div>
        </section>

        <section class="dashboard-row">
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="far fa-calendar-alt"></i> Carga Mensual de Eventos</span>
                </div>
                <div id="chartMonth" style="display: flex; flex-direction: column; gap: 10px;">
                    </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-chart-pie"></i> Estado Global</span>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap: 20px;">
                    
                    <div class="stat-item">
                        <div class="stat-info">
                            <span class="stat-label" style="color:var(--text-sec)">Realizados / Pasados</span>
                            <span class="stat-num" id="globalPasados">0</span>
                        </div>
                        <div class="progress-bar"><div id="barPasados" class="progress-fill" style="width:0%; background:#9ca3af"></div></div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-info">
                            <span class="stat-label" style="color:var(--color-audiencia)">Pendientes / Futuros</span>
                            <span class="stat-num" id="globalFuturos">0</span>
                        </div>
                        <div class="progress-bar"><div id="barFuturos" class="progress-fill" style="width:0%; background:var(--color-audiencia)"></div></div>
                    </div>

                    <div style="margin-top:20px; padding:15px; background:#f9fafb; border-radius:8px; font-size:0.9rem; color:var(--text-sec);">
                        <i class="fas fa-info-circle"></i> Los datos mostrados responden a los filtros de Año y Usuario seleccionados arriba.
                    </div>
                </div>
            </div>

        </section>
    </main>

    <script>
        // --- 1. CONFIGURACIÓN E INICIALIZACIÓN (Usando Compat SDK) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };

        // Inicializar Firebase Compat
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- 2. VARIABLES GLOBALES ---
        let rawData = []; // Documentos crudos
        let allEvents = []; // Eventos aplanados
        let uniqueUsers = new Set();
        let uniqueYears = new Set();

        // --- 3. ELEMENTOS DEL DOM ---
        const userFilter = document.getElementById('userFilter');
        const yearFilter = document.getElementById('yearFilter');
        const loader = document.getElementById('loader');

        // --- 4. FUNCIÓN PARA PROCESAR FECHAS ---
        // Extrae eventos de los documentos (misma lógica que causas.html pero aplanando para el dashboard)
        function extraerEventos(docData, docId, fieldName, typeLabel) {
            const result = [];
            const val = docData[fieldName];
            
            if (!val) return result;

            // Helper para convertir timestamp/date a objeto JS Date
            // Compatible con el objeto Timestamp de Firebase Compat (tiene .toDate())
            const toDate = (v) => {
                if (v && typeof v.toDate === 'function') return v.toDate();
                if (v && v.seconds) return new Date(v.seconds * 1000);
                if (v instanceof Date) return v;
                const d = new Date(v);
                return isNaN(d) ? null : d;
            };

            // Caso Diligencias (Array de objetos con propiedad fecha)
            if (fieldName === 'diligencias' && Array.isArray(val)) {
                 val.forEach(item => {
                    const d = toDate(item.fecha); // Diligencia tiene { fecha: ..., detalle: ... }
                    if (d) result.push({ date: d, type: typeLabel, id: docId, user: docData.usuarioAsignado || 'Sin Asignar' });
                });
                return result;
            }

            // Caso Arrays simples (Audiencias)
            if (Array.isArray(val)) {
                val.forEach(item => {
                    const d = toDate(item);
                    if (d) result.push({ date: d, type: typeLabel, id: docId, user: docData.usuarioAsignado || 'Sin Asignar' });
                });
            } 
            // Caso Fecha Única (Vencimientos, Gesell antiguo, etc)
            else {
                const d = toDate(val);
                if (d) result.push({ date: d, type: typeLabel, id: docId, user: docData.usuarioAsignado || 'Sin Asignar' });
            }
            return result;
        }

        // --- 5. CARGA DE DATOS (SNAPSHOT) ---
        // Usamos la sintaxis Compat: db.collection(...)
        db.collection("causas").onSnapshot((snapshot) => {
            rawData = [];
            allEvents = [];
            uniqueUsers.clear();
            uniqueYears.clear();

            snapshot.forEach(doc => {
                const d = doc.data();
                const id = d.numCausa || doc.id;
                rawData.push(d);

                if (d.usuarioAsignado) uniqueUsers.add(d.usuarioAsignado);

                // Extracción masiva de todos los tipos de eventos
                allEvents.push(...extraerEventos(d, id, 'audiencias', 'Audiencia'));
                allEvents.push(...extraerEventos(d, id, 'audienciaGesell', 'Gesell'));
                allEvents.push(...extraerEventos(d, id, 'vencimiento', 'Vencimiento'));
                allEvents.push(...extraerEventos(d, id, 'vencimientoRecursos', 'Recurso'));
                allEvents.push(...extraerEventos(d, id, 'diligencias', 'Diligencia')); 
            });

            // Poblar años disponibles
            allEvents.forEach(e => uniqueYears.add(e.date.getFullYear()));

            updateFiltersUI();
            calculateStats();
            loader.style.display = 'none';
        }, (error) => {
            console.error("Error obteniendo datos:", error);
            loader.innerHTML = `<div style="color:red">Error de conexión: ${error.message}</div>`;
        });

        // --- 6. GESTIÓN DE LA INTERFAZ (Filtros y Render) ---

        function updateFiltersUI() {
            // Guardar selección actual
            const prevUser = userFilter.value;
            const prevYear = yearFilter.value;

            // Actualizar Usuarios
            userFilter.innerHTML = '<option value="all">-- Todos los Empleados --</option>';
            Array.from(uniqueUsers).sort().forEach(u => {
                const op = document.createElement('option');
                op.value = u; op.textContent = u;
                userFilter.appendChild(op);
            });
            if(prevUser && Array.from(uniqueUsers).includes(prevUser)) userFilter.value = prevUser;

            // Actualizar Años (Orden descendente)
            yearFilter.innerHTML = '<option value="all">Histórico Completo</option>';
            // Si no hay años (BD vacía), usar el actual
            const currentYear = new Date().getFullYear();
            if (uniqueYears.size === 0) uniqueYears.add(currentYear);
            
            Array.from(uniqueYears).sort((a,b)=>b-a).forEach(y => {
                const op = document.createElement('option');
                op.value = y; op.textContent = y;
                // Pre-seleccionar el año actual por defecto si no hay selección previa
                if (!prevYear && y === currentYear) op.selected = true; 
                yearFilter.appendChild(op);
            });
            if(prevYear && (prevYear === 'all' || uniqueYears.has(parseInt(prevYear)))) yearFilter.value = prevYear;
            else if (!prevYear) yearFilter.value = currentYear; // Default al año actual si es la primera carga
        }

        function calculateStats() {
            const sUser = userFilter.value;
            const sYear = yearFilter.value;
            const now = new Date();

            // 1. Filtrar Eventos según selección
            const filtered = allEvents.filter(e => {
                const matchUser = (sUser === 'all') || (e.user === sUser);
                const matchYear = (sYear === 'all') || (e.date.getFullYear() === parseInt(sYear));
                return matchUser && matchYear;
            });

            // 2. Contadores
            const counts = {
                Audiencia: { total: 0, future: 0 },
                Gesell: { total: 0, future: 0 },
                Vencimiento: { total: 0, future: 0 },
                Recurso: { total: 0, future: 0 },
                Diligencia: { total: 0, future: 0 }
            };

            let pasados = 0;
            let futuros = 0;
            const monthCounts = Array(12).fill(0);

            filtered.forEach(e => {
                // Conteo por tipo
                if (counts[e.type]) {
                    counts[e.type].total++;
                    if (e.date > now) counts[e.type].future++;
                }

                // Global futuro/pasado
                if (e.date > now) futuros++; else pasados++;

                // Mes (0-11)
                monthCounts[e.date.getMonth()]++;
            });

            // 3. Renderizar DOM
            
            // KPIs Cards
            updateKPI('valAudiencia', 'subAudiencia', counts.Audiencia);
            updateKPI('valGesell', 'subGesell', counts.Gesell);
            updateKPI('valVenc', null, counts.Vencimiento); 
            updateKPI('valRecurso', null, counts.Recurso);
            updateKPI('valDiligencia', null, counts.Diligencia);

            // Chart Mensual (HTML Bar Chart simple)
            const maxMonth = Math.max(...monthCounts, 1);
            const monthsNames = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            const chartHtml = monthsNames.map((m, i) => {
                const val = monthCounts[i];
                const pct = (val / maxMonth) * 100;
                // Resaltar mes actual solo si estamos viendo el año actual o 'all'
                const isCurrentMonth = (new Date().getMonth() === i && (sYear === 'all' || parseInt(sYear) === new Date().getFullYear()));
                const color = isCurrentMonth ? 'var(--color-audiencia)' : '#d1d5db';
                return `
                    <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem;">
                        <div style="width:30px; font-weight:600; color:${isCurrentMonth?'var(--color-audiencia)':'var(--text-sec)'}">${m}</div>
                        <div style="flex:1; background:#f3f4f6; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="width:${pct}%; height:100%; background:${color}; transition: width 0.5s;"></div>
                        </div>
                        <div style="width:25px; text-align:right; font-weight:bold; color:var(--text-sec)">${val}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('chartMonth').innerHTML = monthCounts.reduce((a,b)=>a+b,0) === 0 ? '<div style="text-align:center; color:var(--text-sec); padding:20px;">Sin eventos en este periodo</div>' : chartHtml;

            // Global Pasados vs Futuros
            const totalGlobal = pasados + futuros;
            document.getElementById('globalPasados').textContent = pasados;
            document.getElementById('globalFuturos').textContent = futuros;
            
            const pctPasados = totalGlobal ? (pasados/totalGlobal)*100 : 0;
            const pctFuturos = totalGlobal ? (futuros/totalGlobal)*100 : 0;

            document.getElementById('barPasados').style.width = `${pctPasados}%`;
            document.getElementById('barFuturos').style.width = `${pctFuturos}%`;
        }

        function updateKPI(idMain, idSub, obj) {
            animateValue(document.getElementById(idMain), obj.total);
            if(idSub) document.getElementById(idSub).textContent = obj.future;
        }

        function animateValue(obj, end) {
            // Actualización directa, se podría agregar lógica de animación numérica progresiva aquí
            obj.textContent = end;
        }

        // Listeners
        userFilter.addEventListener('change', calculateStats);
        yearFilter.addEventListener('change', calculateStats);

    </script>
</body>
</html>
