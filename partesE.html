<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Geográfico de Partes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --primary: #3b82f6;
            --accent: #10b981;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            padding: 20px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        /* HEADER */
        header { margin-bottom: 30px; text-align: left; }
        header h1 { font-size: 1.75rem; font-weight: 700; color: var(--text-main); }
        header p { color: var(--text-sec); font-size: 0.9rem; }

        /* KPIs (Estilo Prioridad) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            display: flex;
            flex-direction: column;
        }

        .kpi-card.alt { border-left-color: var(--accent); }

        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-sec);
            margin-bottom: 10px;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
        }

        /* TABLA SPA */
        .table-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 { font-size: 1.1rem; font-weight: 600; }

        .table-responsive { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; text-align: left; }

        th {
            background: #f1f5f9;
            padding: 14px 20px;
            font-size: 0.75rem;
            color: var(--text-sec);
            text-transform: uppercase;
            font-weight: 700;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        .city-badge {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .count-badge {
            font-weight: 700;
            color: var(--primary);
        }

        /* LOADER */
        #loader {
            position: fixed; inset: 0; background: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.3s;
        }
        .spinner { width: 35px; height: 35px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .kpi-value { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--text-sec); font-size: 0.9rem;">Sincronizando con base de datos...</p>
    </div>

    <div class="container">
        <header>
            <h1></h1>
            <p id="db-status">Estado: Conectando...</p>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-label"><i class="fas fa-file-invoice"></i> Total de Partes</span>
                <span class="kpi-value" id="kpi-total">0</span>
            </div>
            <div class="kpi-card alt">
                <span class="kpi-label"><i class="fas fa-map-marked-alt"></i> Ciudades</span>
                <span class="kpi-value" id="kpi-ciudades">0</span>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h2>Distribución Geográfica</h2>
                <i class="fas fa-filter" style="color: var(--border);"></i>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Ciudad de Origen</th>
                            <th>Cantidad de Registros</th>
                            <th>Representación (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURACIÓN FIREBASE (Según tus datos)
        const firebaseConfig = {
            apiKey: "AIzaSyC871IwG89d3yd-BUY9tj2q0_gmBV3AMfM",
            authDomain: "datos-partes.firebaseapp.com",
            databaseURL: "https://datos-partes-default-rtdb.firebaseio.com",
            projectId: "datos-partes",
            storageBucket: "datos-partes.firebasestorage.app",
            messagingSenderId: "277413385546",
            appId: "1:277413385546:web:9863aaa081727a84479db3"
        };

        // 2. INICIALIZACIÓN
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 3. REFERENCIA AL NODO CORRECTO ('registros')
        // Se utiliza 'registros' porque es el nodo definido en partes.html para guardar datos.
        const refPartes = database.ref('registros');

        // 4. LÓGICA DE CARGA SPA
        refPartes.on('value', (snapshot) => {
            const data = snapshot.val();
            const loader = document.getElementById('loader');
            const tableBody = document.getElementById('table-body');
            const totalKPI = document.getElementById('kpi-total');
            const ciudadesKPI = document.getElementById('kpi-ciudades');
            const status = document.getElementById('db-status');

            if (!data) {
                totalKPI.innerText = "0";
                ciudadesKPI.innerText = "0";
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:gray;">No hay datos en la colección "registros"</td></tr>';
                loader.style.opacity = "0";
                setTimeout(() => loader.style.display = "none", 300);
                status.innerText = "Estado: Sin datos";
                return;
            }

            const listaRegistros = Object.values(data);
            const total = listaRegistros.length;
            
            // Conteo por ciudad
            const conteo = {};
            listaRegistros.forEach(r => {
                let ciudad = (r.ciudad && r.ciudad.trim() !== "") ? r.ciudad.trim().toUpperCase() : "NO ESPECIFICADO";
                conteo[ciudad] = (conteo[ciudad] || 0) + 1;
            });

            // Ordenar por cantidad descendente
            const ciudadesOrdenadas = Object.entries(conteo).sort((a, b) => b[1] - a[1]);

            // Actualizar Interfaz
            totalKPI.innerText = total;
            ciudadesKPI.innerText = Object.keys(conteo).length;
            status.innerText = "Estado: Sincronizado (" + new Date().toLocaleTimeString() + ")";

            tableBody.innerHTML = '';
            ciudadesOrdenadas.forEach(([nombre, cantidad]) => {
                const porcentaje = ((cantidad / total) * 100).toFixed(1);
                const fila = `
                    <tr>
                        <td><span class="city-badge">${nombre}</span></td>
                        <td><span class="count-badge">${cantidad}</span> partes</td>
                        <td>
                            <div style="font-size: 0.85rem; color: var(--text-sec);">${porcentaje}%</div>
                            <div style="width: 100%; height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 4px;">
                                <div style="width: ${porcentaje}%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += fila;
            });

            // Ocultar loader
            loader.style.opacity = "0";
            setTimeout(() => loader.style.display = "none", 300);

        }, (error) => {
            console.error("Error de Firebase:", error);
            document.getElementById('db-status').innerText = "Error: " + error.message;
        });
    </script>
</body>
</html>
